name: LeetCode Master Sync

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * *"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # STEP 1: Sync all languages (TS, Rust, Go, JS, etc.)
      - name: Sync Code Files
        uses: LeetCode-OpenSource/leetcode-sync@v1.1
        with:
          github-token: ${{ github.token }}
          leetcode-session: ${{ secrets.LEETCODE_SESSION }}
          leetcode-csrf-token: ${{ secrets.LEETCODE_CSRF_TOKEN }}
          filter-duplicate-solutions: true
          # This organizes your files into folders by language!
          destination-folder: "solutions" 

      # STEP 2: Custom Python Stats Updater
      - name: Update README Stats
        run: |
          python -c "
          import requests
          import re
          import os

          user = 'Asmit_S'
          try:
              resp = requests.get(f'https://leetcode-stats-api.herokuapp.com/{user}').json()
              if resp.get('status') == 'success':
                  stats = f'\n| Difficulty | Solved | Total |\n| :--- | :--- | :--- |\n| ðŸŸ¢ Easy | {resp[\"easySolved\"]} | {resp[\"totalEasy\"]} |\n| ðŸŸ¡ Medium | {resp[\"mediumSolved\"]} | {resp[\"totalMedium\"]} |\n| ðŸ”´ Hard | {resp[\"hardSolved\"]} | {resp[\"totalHard\"]} |\n| **Total** | **{resp[\"totalSolved\"]}** | **{resp[\"totalQuestions\"]}** |\n'
                  
                  if os.path.exists('README.md'):
                      with open('README.md', 'r') as f:
                          content = f.read()
                      pattern = r'.*?'
                      replacement = f'{stats}'
                      new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
                      with open('README.md', 'w') as f:
                          f.write(new_content)
          except Exception as e:
              print(f'Error updating stats: {e}')
          "

      # STEP 3: Commit and Push
      - name: Commit and Push
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git add .
          git commit -m "Sync: Multi-language solutions (Rust/Go/TS) and Stats updated" || echo "No changes"
          git push